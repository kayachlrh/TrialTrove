<!DOCTYPE html>
<html class="no-js" lang="zxx"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
  <style>
        .chat-name {
            font-size: 14px;
            font-weight: bold;
            background-color: #eee;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            margin-bottom: 5px;
        }
        .right .chat-name {
            color: blue; /* ë‚´ ì•„ì´ë”” ìƒ‰ìƒ */
        }
        .left .chat-name{
            color: green; /* ìƒëŒ€ë°© ì•„ì´ë”” ìƒ‰ìƒ */
        }
    </style>
</head>


<body>
<th:block layout:fragment="content">

  <!-- Start Breadcrumbs -->
  <div class="breadcrumbs">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-6 col-md-6 col-12">
          <div class="breadcrumbs-content">
            <h1 class="page-title">messages</h1>
          </div>
        </div>
        <div class="col-lg-6 col-md-6 col-12">
          <ul class="breadcrumb-nav">
            <li><a href="../main/index.html">Home</a></li>
            <li>messages</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  <!-- End Breadcrumbs -->

  <!-- Start Dashboard Section -->
  <section class="dashboard section">
    <div class="container">
      <div class="row">
        <div class="col-lg-3 col-md-4 col-12">
          <!-- Start Dashboard Sidebar -->
          <div class="dashboard-sidebar">
            <h3 th:text="${#authentication.principal.username}">
              <span><a href="javascript:void(0)" th:text="${#authentication.principal.username}"></a></span>
            </h3>
            <div class="dashboard-menu">
              <ul>
                <li><a href="/member/myInfo"><i class="lni lni-pencil-alt"></i>
                  ë‚´ ì •ë³´ </a></li>
                <li><a href="/product/favorite"><i class="lni lni-heart"></i> ë³´ë¬¼í•¨ </a></li>
                <li><a href="/member/trialMap"><i class="lni lni-bookmark"></i> ë³´ë¬¼ì§€ë„ </a></li>
                <li><a class="active" href="/message"><i class="lni lni-envelope"></i> ë©”ì‹œì§€ </a></li>

                <!-- ê´€ë¦¬ì ì²´í—˜ë“±ë¡ ë§í¬ -->
                <li th:if="${#authorization.expression('hasRole(''ROLE_ADMIN'')')}">
                  <a href="../product/enroll"><i class="lni lni-circle-plus"></i> ì²´í—˜ë“±ë¡ </a>
                </li>

                <!-- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ë§í¬ -->
                <li th:if="${#authorization.expression('hasRole(''ROLE_ADMIN'')')}">
                  <a href="/admin/dashboard"><i class="lni lni-dashboard"></i> Dashboard</a>
                </li>

                <li><a href="/member/delete"><i class="lni lni-trash"></i> íšŒì›íƒˆí‡´ </a></li>
              </ul>
              <div class="button">
                <a class="btn" th:href="@{/member/logout}">Logout</a>
              </div>
            </div>
          </div>
          <!-- Start Dashboard Sidebar -->
        </div>
        <div class="col-lg-9 col-md-8 col-12">
          <div class="main-content">
            <div class="dashboard-block mt-0 pb-0">
              <h3 class="block-title mb-0">Messages</h3>
              <!-- Start Messages Body -->
              <div class="messages-body">
                <div class="form-head">
                  <div class="row align-items-center">
                    <div class="col-lg-5 col-12">
                      <form class="chat-search-form">
                        <input type="text" placeholder="Search username" name="search">
                        <button value="search" type="submit"><i
                                class="lni lni-search-alt"></i></button>
                      </form>
                    </div>
                    <div class="col-lg-7 col-12 align-right">
                      <h3 class="username-title" th:text="${#authentication.principal.username}"></h3>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-lg-5 col-12">
                    <!-- Start User List -->
                    <div class="user-list">
                      <ul>
                        <!-- Start Single List -->
                        <li th:each="member : ${members}">
                          <a href="javascript:void(0)">
                            <!-- ì˜¨ë¼ì¸ ì—¬ë¶€ -->
                            <div class="image busy"></div> <!-- ê¸°ë³¸ì€ ì˜¤í”„ë¼ì¸ -->
                            <span class="username" th:text="${member.userId}"></span>
                            <span class="unseen-message" th:text="${unreadCounts != null && unreadCounts[member.userId] != null ? unreadCounts[member.userId] : '0'}"></span> <!-- ë¯¸í™•ì¸ ë©”ì‹œì§€ ìˆ˜ (ì„ì‹œ) -->
                          </a>
                        </li>
                        <!-- End Single List -->
                      </ul>
                    </div>
                    <!-- End User List -->
                  </div>
                  <div class="col-lg-7 col-12">
                    <!-- Start Chat List -->
                    <div class="chat-list" style="display: none;">
                      <ul class="single-chat-head" id="chatList">
                        <!-- ì±„íŒ… ë³¸ë¬¸ -->
                      </ul>
                      <div class="reply-block">
                        <input id="messageInput" name="reply" type="text" placeholder="Type your message here...">
                        <button class="reply-btn"><img
                                src="/static/assets/images/messages/send.svg" alt="#"></button>
                      </div>
                    </div>
                    <!-- End Chat List -->
                  </div>
                </div>
              </div>
              <!-- End Messages Body -->
          </div>
        </div>
      </div>
    </div>
    </div>
  </section>
  <!-- End Dashboard Section -->

  <!-- ========================= scroll-top ========================= -->
  <a href="#" class="scroll-top btn-hover">
    <i class="lni lni-chevron-up"></i>
  </a>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

  <script>
let stompClient = null;
let currentChatUser = null; // í˜„ì¬ ì±„íŒ… ì¤‘ì¸ ì‚¬ìš©ì ID
let currentUserId = document.querySelector(".username-title").textContent.trim(); // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸°
let loadedMessages = {};


// ğŸ”¹ WebSocket ì—°ê²° í•¨ìˆ˜
function connect() {
    let socket = new SockJS('/ws'); // WebSocket ì—”ë“œí¬ì¸íŠ¸
    stompClient = Stomp.over(socket);

    stompClient.connect({}, async function (frame) {
        console.log('Connected: ' + frame);

        // âœ… ì›¹ì†Œì¼“ ì—°ê²° í›„ ë¯¸í™•ì¸ ë©”ì‹œì§€ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸°
        await fetchUnreadMessages();

        // ğŸ”¹ ì „ì²´ ì±„íŒ… ë©”ì‹œì§€ êµ¬ë… (ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ë©”ì‹œì§€ê°€ ì „ë‹¬ë¨)
        stompClient.subscribe('/topic/chat', function (message) {
            let receivedMessage = JSON.parse(message.body);
            console.log("Received:", receivedMessage);
            displayMessage(receivedMessage);
        });

        // ğŸ”¹ ì˜¨ë¼ì¸ ìœ ì € ëª©ë¡ êµ¬ë… (ì—°ê²°ëœ í›„ ì‹¤í–‰)
        stompClient.subscribe('/topic/onlineUsers', function (message) {
            let onlineUsers = JSON.parse(message.body);
            console.log("ì˜¨ë¼ì¸ ìœ ì € ëª©ë¡ ì—…ë°ì´íŠ¸:", onlineUsers);
            updateOnlineStatus(onlineUsers);
        });

        // ğŸ”¹ í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ì˜¨ë¼ì¸ ìƒíƒœë¥¼ ì„œë²„ì— ì „ì†¡ (ì—°ê²°ëœ í›„ ì‹¤í–‰)
        stompClient.send("/app/user.online", {}, JSON.stringify({ userId: currentUserId }));
    });
}

// ğŸ”¹ ì˜¨ë¼ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateOnlineStatus(onlineUsers) {
    document.querySelectorAll(".user-list li").forEach(li => {
        let usernameElement = li.querySelector(".username");
        if (!usernameElement) return;

        let userId = usernameElement.textContent.trim();
        let imageElement = li.querySelector(".image");
        let unseenMessageElement = li.querySelector(".unseen-message");

        let userInfo = onlineUsers.find(user => user.userId === userId);

        if (userInfo) {
            imageElement.classList.remove("busy"); // ì˜¨ë¼ì¸ ìƒíƒœ
        } else {
            imageElement.classList.add("busy"); // ì˜¤í”„ë¼ì¸ ìƒíƒœ
        }
    });
    fetchUnreadMessages();
}

// ğŸ”¹ ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
function sendMessage() {
    let messageInput = document.getElementById("messageInput");
    let messageContent = messageInput.value.trim();

    if (!messageContent || !currentChatUser) {
        console.log("ë©”ì‹œì§€ ë‚´ìš©ì´ ì—†ê±°ë‚˜, ì±„íŒ… ìƒëŒ€ê°€ ì„ íƒë˜ì§€ ì•ŠìŒ");
        return;
    }

    let chatMessage = {
        senderUserId: currentUserId, // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì
        receiverUserId: currentChatUser, // í˜„ì¬ ëŒ€í™” ì¤‘ì¸ ìƒëŒ€ë°©
        content: messageContent
    };

    // WebSocketì„ í†µí•´ ë©”ì‹œì§€ ì „ì†¡
    stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));


    messageInput.value = ""; // ì…ë ¥ì°½ ì´ˆê¸°í™”
}

// ğŸ”¹ ë©”ì‹œì§€ í™”ë©´ì— ì¶”ê°€ í•¨ìˆ˜
function displayMessage(message) {
    let chatList = document.getElementById("chatList");
    let messageItem = document.createElement("li");
    messageItem.setAttribute("data-message-id", message.id);

    if (message.senderUserId === currentUserId) {
        messageItem.className = "right"; // ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€
        messageItem.innerHTML = `
            <h3 class="chat-name">${message.senderUserId}</h3>
            <p class="text">${message.content}</p>
            <span class="time">${new Date(message.timestamp).toLocaleTimeString()}</span>
        `;
    } else {
        messageItem.className = "left"; // ìƒëŒ€ê°€ ë³´ë‚¸ ë©”ì‹œì§€
        messageItem.innerHTML = `
            <h3 class="chat-name">${message.senderUserId}</h3>
            <p class="text">${message.content}</p>
            <span class="time">${new Date(message.timestamp).toLocaleTimeString()}</span>
        `;
    }

    chatList.appendChild(messageItem);
    chatList.scrollTop = chatList.scrollHeight; // ìŠ¤í¬ë¡¤ ìë™ ì´ë™
}

// ğŸ”¹ ì±„íŒ…ë°© ì„ íƒ ì´ë²¤íŠ¸ (í´ë¦­í•œ ìœ ì €ì™€ ëŒ€í™” ì‹œì‘)
document.querySelectorAll(".user-list li a").forEach(item => {
    item.addEventListener("click", async function () {
        const receiverUserId = this.querySelector(".username").textContent.trim();
        console.log("ì±„íŒ… ìƒëŒ€:", receiverUserId);  // ê°’ í™•ì¸

        if (!receiverUserId) {
            console.error("Invalid user ID format");
            return;
        }

        // í•´ë‹¹ ì‚¬ìš©ìì˜ ì±„íŒ…ë°©ì´ ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸
        if (currentChatUser === receiverUserId) {
            console.log("ì±„íŒ…ë°©ì´ ì´ë¯¸ ì—´ë ¤ìˆìŠµë‹ˆë‹¤.");
            return;
        }

        // í˜„ì¬ ì±„íŒ… ìƒëŒ€ ì„¤ì •
        currentChatUser = receiverUserId;

        console.log("ğŸŸ¢ í˜„ì¬ ì±„íŒ… ìƒëŒ€ ì„¤ì •ë¨ (ID):", currentChatUser);

        let usernameTitle = document.querySelector(".username-title");
        if (usernameTitle) {
            usernameTitle.textContent = receiverUserId;
        }

        document.querySelector(".chat-list").style.display = "block";

        // ì±„íŒ…ë°©ì„ ì „í™˜í•  ë•Œë§ˆë‹¤ ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
        let chatList = document.getElementById("chatList");
        chatList.innerHTML = "";

        try {
            let response = await fetch(`/messages/mark-as-read/${currentChatUser}`, { method: "POST" });
            let result = await response.json();
            console.log("ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ ê²°ê³¼:", result);

            // ë©”ì‹œì§€ë¥¼ ì½ì—ˆìœ¼ë©´ ìˆ«ìë„ ì—…ë°ì´íŠ¸
            let unseenMessageElement = this.querySelector(".unseen-message");
            if (unseenMessageElement) {
                unseenMessageElement.textContent = "0";
            }
        } catch (error) {
            console.error("ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }

        // ë©”ì‹œì§€ ë‚´ì—­ì´ ë¡œë“œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        if (!loadedMessages[currentChatUser]) {
              await loadMessageHistory(currentChatUser);
          } else {
              console.log("ì´ë¯¸ ë©”ì‹œì§€ ë‚´ì—­ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
              // ì´ì „ì— ë¶ˆëŸ¬ì˜¨ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— í‘œì‹œ
              loadedMessages[currentChatUser].forEach(message => {
                  displayMessage(message);
              });
          }
    });
});

// ğŸ”¹ ì´ì „ ì±„íŒ… ë‚´ì—­ì„ ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadMessageHistory(receiverUserId) {
     try {
        // ëŒ€í™” ë‚´ì—­ì„ ì„œë²„ì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const response = await fetch(`/messages?receiver=${receiverUserId}`);
        const messages = await response.json();  // ì„œë²„ì—ì„œ JSONìœ¼ë¡œ ë°˜í™˜ëœ ë©”ì‹œì§€ ëª©ë¡

        // ë©”ì‹œì§€ê°€ ìˆì„ ê²½ìš°, ëª¨ë“  ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶œë ¥
        if (messages && messages.length > 0) {
           // íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ì¤€ìœ¼ë¡œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
            messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));


           // ë©”ì‹œì§€ë¥¼ ì €ì¥
           loadedMessages[receiverUserId] = messages;

            // ì •ë ¬ëœ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶”ê°€
            messages.forEach(message => {
                displayMessage(message);  // ê° ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶”ê°€
            });
        }
    } catch (error) {
        console.error("ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
    }
}

// ğŸ”¹ ì±„íŒ…ë°© ë‹«ì„ ë•Œ ìƒíƒœ ì´ˆê¸°í™”
function closeChat() {
    currentChatUser = null;
    loadedMessages = {};  // ë©”ì‹œì§€ ë‚´ì—­ ì´ˆê¸°í™”
    document.querySelector(".chat-list").style.display = "none";  // ì±„íŒ… ë¦¬ìŠ¤íŠ¸ ìˆ¨ê¸°ê¸°
}

// ğŸ”¹ ë¯¸í™•ì¸ ë©”ì‹œì§€ ê°œìˆ˜ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
async function fetchUnreadMessages() {
    try {
        let response = await fetch(`/messages/unread/${currentUserId}`);
        if (!response.ok) {
            throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
        }

        let unreadMessages = await response.json();
        console.log("ğŸ“© ë¯¸í™•ì¸ ë©”ì‹œì§€ ê°œìˆ˜:", unreadMessages);

        // ğŸ”¹ ë¯¸í™•ì¸ ë©”ì‹œì§€ ê°œìˆ˜ë¥¼ UIì— ì ìš©
        document.querySelectorAll(".user-list li").forEach(li => {
            let usernameElement = li.querySelector(".username");
            if (!usernameElement) return;

            let userId = usernameElement.textContent.trim();
            let unseenMessageElement = li.querySelector(".unseen-message");

            let unreadCount = unreadMessages[userId] || 0; // userIdì— í•´ë‹¹í•˜ëŠ” ë¯¸í™•ì¸ ë©”ì‹œì§€ ê°œìˆ˜

            if (unseenMessageElement) {
                unseenMessageElement.textContent = unreadCount > 0 ? unreadCount : "0";
            }
        });

    } catch (error) {
        console.error("ë¯¸í™•ì¸ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
    }
}

// ğŸ”¹ ë²„íŠ¼ í´ë¦­ ì‹œ ë©”ì‹œì§€ ì „ì†¡
document.querySelector(".reply-btn").addEventListener("click", function () {
    console.log("Send button clicked!");
    sendMessage();
});

// ğŸ”¹ ì—”í„°í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
document.getElementById("messageInput").addEventListener("keypress", function (e) {
    if (e.key === "Enter") {
        sendMessage();
    }
});

// ğŸ”¹ ì´ˆê¸° WebSocket ì—°ê²° ì‹¤í–‰
connect();


</script>
</th:block>
</body>
</html>